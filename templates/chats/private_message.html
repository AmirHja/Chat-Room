{% block content %}
<div class="chat-container">
    <div class="chat-sidebar">
        <h3>ContactsðŸ‘¥</h3>
        <button id="new-chat-btn">New chatâž•</button>
        <ul id="chat-list">
            {% for partner in chat_partners %}
                <li>
                    <a href="#" class="chat-user" data-username="{{ partner.username }}">
                        {{ partner.username }}
                    </a>
                </li>
            {% endfor %}
        </ul>
    </div>

    <div class="chat-box">
        <h3 id="chat-title">SELECT A PVðŸ”µ</h3>
        <div id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="Message...">
        <button id="send-btn">SendðŸ“¤</button>
    </div>
</div>
    
<script>
    let selectedUser = null;
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("chat-input");
    const chatList = document.getElementById("chat-list");

    document.querySelectorAll(".chat-user").forEach(user => {
        user.addEventListener("click", function () {
            selectedUser = this.dataset.username;
            document.getElementById("chat-title").innerText = `${selectedUser}ðŸ—£ï¸`;
            chatMessages.innerHTML = "Loading...";

            fetch(`/chat/load_messages/${selectedUser}/`)
                .then(response => response.json())
                .then(data => {
                    chatMessages.innerHTML = "";
                    data.messages.forEach(msg => {
                        chatMessages.innerHTML += `<p><b>${msg.sender}:</b> ${msg.message} <small>${msg.timestamp}</small></p>`;
                    });
                });
        });
    });

    document.getElementById("send-btn").addEventListener("click", function () {
        if (selectedUser && chatInput.value.trim() !== "") {
            fetch(`/chat/send_message/`, {
                method: "POST",
                headers: { "X-CSRFToken": "{{ csrf_token }}", "Content-Type": "application/x-www-form-urlencoded" },
                body: `receiver=${selectedUser}&message=${chatInput.value}`
            })
            .then(response => response.json())
            .then(data => {
                chatMessages.innerHTML += `<p><b>{{user}}:</b> ${data.message} <small>${data.timestamp}</small></p>`;
                chatInput.value = "";
            });
        }
    });


    document.getElementById("new-chat-btn").addEventListener("click", function () {
        let newUser = prompt("Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø´Ø®Øµ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯:");
        if (newUser) {
            let newChat = document.createElement("li");
            newChat.innerHTML = `<a href="#" class="chat-user" data-username="${newUser}">${newUser}</a>`;
            chatList.appendChild(newChat);

            newChat.querySelector("a").addEventListener("click", function () {
                selectedUser = newUser;
                document.getElementById("chat-title").innerText = `ðŸ”µ Ú†Øª Ø¨Ø§ ${selectedUser}`;
                chatMessages.innerHTML = "Ú†Øª Ø¬Ø¯ÛŒØ¯ Ø´Ø±ÙˆØ¹ Ø´Ø¯!";
            });
        }
    });
</script>

<!-- Ø§Ø³ØªØ§ÛŒÙ„â€ŒÙ‡Ø§ -->
<style>
    .chat-container { display: flex; gap: 20px; }
    .chat-sidebar { width: 220px; border-right: 2px solid #ccc; padding: 10px; }
    .chat-box { flex-grow: 1; }
    #chat-messages { min-height: 200px; border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
    button { cursor: pointer; padding: 5px 10px; }
</style>
{% endblock %}
